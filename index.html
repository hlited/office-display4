<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilingual Signage - Imgur Fix</title>
    <style>
        :root { --main-blue: #003366; }
        body, html { margin: 0; padding: 0; width: 1080px; height: 1920px; font-family: "Microsoft JhengHei", Arial, sans-serif; overflow: hidden; background: #fff; }
        
        header { 
            height: 180px; display: flex; justify-content: space-between; align-items: center; 
            padding: 0 60px; border-bottom: 8px solid var(--main-blue); background: white;
            position: relative; z-index: 10;
        }
        .logo img { height: 60px; width: auto; }
        .clock-box { text-align: right; }
        #time { font-size: 85px; font-weight: 900; color: var(--main-blue); line-height: 1; }
        #date { font-size: 30px; color: #666; font-weight: bold; margin-bottom: 5px; }

        .viewport { position: relative; height: 1740px; width: 1080px; overflow: hidden; }
        .section { position: absolute; width: 100%; height: 100%; display: none; }
        .section.active { display: block; }

        /* Ë°®Ê†ºÊ®£Âºè */
        .title-area { padding: 50px 60px 30px; display: flex; justify-content: space-between; align-items: flex-end; }
        .title .zh { font-size: 72px; font-weight: bold; color: var(--main-blue); display: block; }
        .title .en { font-size: 38px; color: #555; }
        .page-indicator { font-size: 32px; color: #bbb; font-weight: bold; }

        .table-container { width: 980px; margin: 0 auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        thead th { border-bottom: 5px solid var(--main-blue); padding: 25px 10px; text-align: left; }
        .th-zh { font-size: 42px; color: #000; display: block; }
        .th-en { font-size: 24px; color: #777; font-weight: normal; }
        
        tbody td { padding: 45px 15px; border-bottom: 1px solid #eee; vertical-align: top; height: 230px; }
        .cell-zh { font-size: 48px; font-weight: bold; display: block; color: #222; margin-bottom: 12px; line-height: 1.2; }
        .cell-en { font-size: 30px; display: block; color: #666; line-height: 1.2; }
        
        .venue-box { background: #e7f2ff; padding: 15px 20px; border-radius: 12px; display: inline-block; width: 92%; }
        .venue-box .cell-zh { color: #0066cc; }

        /* ÂúñÁâáË®≠ÂÆöÔºö‰ΩøÁî® Imgur ÈÄ£ÁµêÊôÇ object-fit: contain ÊúÄÂÆâÂÖ® */
        #poster-img { width: 100%; height: 100%; object-fit: contain; background: #f4f4f4; }
        
        /* Èô§ÈåØÊ°ÜÊ®£Âºè */
        #debug-console {
            position: fixed; bottom: 0; right: 0; width: 600px; max-height: 400px;
            background: rgba(0,0,0,0.9); color: #0f0; font-family: monospace; font-size: 16px;
            padding: 15px; overflow-y: auto; z-index: 9999; display: block; border-top-left-radius: 10px;
        }
    </style>
</head>
<body>

<header>
    <div class="logo"><img src="logo.png" onerror="this.src='https://via.placeholder.com/300x80?text=LOGO'"></div>
    <div class="clock-box">
        <div id="date">--/--/--</div>
        <div id="time">00:00</div>
    </div>
</header>

<div class="viewport">
    <div id="schedule-sec" class="section">
        <div class="title-area">
            <div class="title">
                <span class="zh">ÊòØÊó•Ê¥ªÂãïË°®</span><span class="en">Daily Schedule</span>
            </div>
            <div id="page-num" class="page-indicator"></div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="22%"><span class="th-zh">ÊôÇÈñì</span><span class="th-en">Time</span></th>
                        <th width="48%"><span class="th-zh">Â†¥Âú∞</span><span class="th-en">Venue</span></th>
                        <th width="30%"><span class="th-zh">Ê©üÊßã/Ê¥ªÂãï</span><span class="th-en">Organizations/Events</span></th>
                    </tr>
                </thead>
                <tbody id="data-list"></tbody>
            </table>
        </div>
    </div>
    <div id="poster-sec" class="section">
        <img id="poster-img" src="" onerror="handleImgError(this)">
    </div>
</div>

<div id="debug-console">System initializing...</div>

<script>
    // Ë´ãÊ≥®ÊÑèÔºöÈÄôË£°ÁöÑ gid=6573573 Â∞çÊáâÊÇ®ÂéüÊú¨ÁöÑÊµ∑Â†±ÂàÜÈ†Å
    const scheduleUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcXft1rOplV2fP2kvm81qdI3gJ4iLaRjX-SsnIwsxRALBwfDvfQtjk8_HWJEdDe0G83oTZHeiLcdwp/pub?gid=0&single=true&output=csv';
    const posterUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcXft1rOplV2fP2kvm81qdI3gJ4iLaRjX-SsnIwsxRALBwfDvfQtjk8_HWJEdDe0G83oTZHeiLcdwp/pub?gid=6573573&single=true&output=csv';

    let allTodayData = [];
    let posterList = [];
    let currentSchedulePage = 0;
    let currentPosterIdx = 0;
    const rowsPerPage = 5; 

    function debugLog(msg) {
        const box = document.getElementById('debug-console');
        const time = new Date().toLocaleTimeString();
        box.innerHTML = `[${time}] ${msg}<br>` + box.innerHTML;
    }

    // Google Drive ÈÄ£ÁµêËΩâÊèõ (‰øùÁïôÊ≠§ÂäüËÉΩ‰ª•ÂÇô‰∏çÊôÇ‰πãÈúÄÔºåImgur ÈÄ£ÁµêÊúÉÁõ¥Êé•ÈÄöÈÅé)
    function convertLink(url) {
        if (!url) return '';
        if (url.includes('drive.google.com') && url.includes('/d/')) {
            const idMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (idMatch && idMatch[1]) return `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
        }
        return url;
    }

    function parseCSV(text) {
        return text.split(/\r?\n/).map(line => {
            let parts = [], curr = '', inQ = false;
            for (let c of line) {
                if (c === '"') inQ = !inQ;
                else if (c === ',' && !inQ) { parts.push(curr.trim()); curr = ''; }
                else curr += c;
            }
            parts.push(curr.trim());
            return parts;
        }).filter(r => r.length > 1);
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('date').innerHTML = now.toLocaleDateString('zh-TW', {year:'numeric', month:'long', day:'numeric', weekday:'long'}) + " | " + now.toLocaleDateString('en-US', {month:'short', day:'numeric', weekday:'short'});
        document.getElementById('time').innerText = now.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12: false});
    }

    function handleImgError(img) {
        // Èò≤Ê≠¢ÁÑ°ÈôêÂæ™Áí∞Â†±ÈåØ
        if (posterList.length === 0) return; 
        debugLog(`‚ùå Load failed: ${img.src.substring(0,30)}...`);
        
        // ÂòóË©¶‰∏ã‰∏ÄÂºµ
        if (posterList.length > 1) {
            currentPosterIdx = (currentPosterIdx + 1) % posterList.length;
            setTimeout(() => { img.src = posterList[currentPosterIdx]; }, 1000);
        }
    }

    async function fetchData() {
        try {
            debugLog("üîÑ Fetching data from Google...");
            // Âä†ÂÖ•Èö®Ê©üÂèÉÊï∏ &rand= ‰ª•Âº∑Âà∂ÈÅøÈñãÁÄèË¶ΩÂô®Á∑©Â≠òÔºå‰ΩÜÁÑ°Ê≥ïÈÅøÈñã Google ‰º∫ÊúçÂô®Á´ØÁ∑©Â≠ò
            const [pRes, sRes] = await Promise.all([
                fetch(posterUrl + '&rand=' + Math.random()), 
                fetch(scheduleUrl + '&rand=' + Math.random())
            ]);

            // --- Êµ∑Â†±ËôïÁêÜËàáË®∫Êñ∑ ---
            const pText = await pRes.text();
            
            // ‚òÖ‚òÖ‚òÖ ÈóúÈçµË®∫Êñ∑ÔºöÂç∞Âá∫ CSV ÁöÑÂâç 100 ÂÄãÂ≠óÂÖÉ ‚òÖ‚òÖ‚òÖ
            // Â¶ÇÊûúÈÄôË£°È°ØÁ§∫ÁöÑÊòØ header (Â¶Ç "Link, Description")Ôºå‰ΩÜÊ≤íÊúâ‰∏ãÈù¢ÁöÑÈÄ£ÁµêÔºå‰ª£Ë°® Google Á∑©Â≠òÈÇÑÊ≤íÊõ¥Êñ∞
            // Â¶ÇÊûúÈÄôË£°È°ØÁ§∫ÁöÑÊòØ "Time, Venue" (Ê¥ªÂãïË°®ÁöÑÊ®ôÈ°å)Ôºå‰ª£Ë°® GID Ë≤ºÈåØ‰∫Ü
            debugLog(`üìÑ Raw CSV Header: ${pText.substring(0, 100).replace(/\n/g, ' ')}...`);

            const pRows = parseCSV(pText);
            // ÊêúÂ∞ãÊâÄÊúâÂåÖÂê´ http ÁöÑÂÑ≤Â≠òÊ†º (ÂêåÊôÇÊîØÊè¥ Google Drive Âíå Imgur)
            posterList = pRows
                .map(row => row.find(cell => cell && (cell.includes('http://') || cell.includes('https://'))))
                .filter(url => url && url.length > 10)
                .map(url => convertLink(url));

            debugLog(`‚úÖ Posters found in CSV: ${posterList.length}`);
            if (posterList.length > 0) {
                debugLog(`First poster: ${posterList[0]}`);
            } else {
                debugLog(`‚ö†Ô∏è Warning: CSV downloaded but no links found.`);
            }

            // --- Ê¥ªÂãïËôïÁêÜ ---
            const sText = await sRes.text();
            const rows = parseCSV(sText);
            const now = new Date();
            const todayStr = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getFullYear()).slice(-2)}`;
            
            const seen = new Set();
            allTodayData = rows.slice(1).filter(row => {
                const isToday = row[0] === todayStr;
                const uniqueKey = row.join('|');
                if (isToday && !seen.has(uniqueKey)) {
                    seen.add(uniqueKey);
                    return true;
                }
                return false;
            });
            debugLog(`‚úÖ Events today: ${allTodayData.length}`);

        } catch(e) { 
            debugLog(`‚ùå Error: ${e.message}`);
        }
    }

    function renderTablePage(pageIdx) {
        const tbody = document.getElementById('data-list');
        tbody.innerHTML = '';
        const start = pageIdx * rowsPerPage;
        const pageData = allTodayData.slice(start, start + rowsPerPage);
        
        pageData.forEach(row => {
            tbody.innerHTML += `<tr>
                <td><span class="cell-zh">${row[1]}</span></td>
                <td><div class="venue-box"><span class="cell-zh">${row[3]||''}</span><span class="cell-en">${row[4]||''}</span></div></td>
                <td><span class="cell-zh">${row[5]||''}</span><span class="cell-en">${row[6]||''}</span></td>
            </tr>`;
        });
        const totalPages = Math.ceil(allTodayData.length / rowsPerPage);
        document.getElementById('page-num').innerText = `Page ${pageIdx + 1} / ${totalPages}`;
    }

    function mainLoop() {
        const schSec = document.getElementById('schedule-sec');
        const posSec = document.getElementById('poster-sec');
        const totalPages = Math.ceil(allTodayData.length / rowsPerPage);

        // ÈÇèËºØÔºöÊúâÊ¥ªÂãï‰∏îÊú™Êí≠ÂÆå -> Êí≠Ê¥ªÂãï
        if (allTodayData.length > 0 && currentSchedulePage < totalPages) {
            schSec.classList.add('active');
            posSec.classList.remove('active');
            renderTablePage(currentSchedulePage);
            currentSchedulePage++;
            setTimeout(mainLoop, 12000); 
        } 
        // ÈÇèËºØÔºöÊúâÊµ∑Â†± -> Êí≠Êµ∑Â†±
        else if (posterList.length > 0) {
            schSec.classList.remove('active');
            posSec.classList.add('active');
            
            // Á¢∫‰øùÂúñÁâá src ÊúâÊõ¥Êñ∞
            const imgEl = document.getElementById('poster-img');
            if (imgEl.src !== posterList[currentPosterIdx]) {
                debugLog(`Displaying: ${posterList[currentPosterIdx].split('/').pop()}`); // Âè™Âç∞Âá∫Ê™îÂêç
                imgEl.src = posterList[currentPosterIdx];
            }

            currentPosterIdx = (currentPosterIdx + 1) % posterList.length;
            currentSchedulePage = 0; 
            setTimeout(mainLoop, 15000); 
        } 
        // ÈÇèËºØÔºöÊ≤íË≥áÊñô -> Á≠âÂæÖ
        else {
            currentSchedulePage = 0;
            // Â¶ÇÊûúÊ≤íË≥áÊñôÔºå5ÁßíÂæåÈáçË©¶‰∏ÄÊ¨°‰∏ªËø¥Âúà
            setTimeout(mainLoop, 5000);
        }
    }

    updateClock();
    setInterval(updateClock, 1000);
    fetchData().then(() => mainLoop());
    setInterval(fetchData, 600000); // 10ÂàÜÈêòÈáçÊñ∞Êäì‰∏ÄÊ¨°Ë≥áÊñô
</script>
</body>
</html>
