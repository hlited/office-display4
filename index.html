<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動看板</title>
    <style>
        :root { --main-blue: #003366; --line-color: #d1e7ff; }
        body, html { margin: 0; padding: 0; width: 1080px; height: 1920px; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; background: #fff; }
        
        /* 頂部 Header */
        header { 
            height: 180px; display: flex; justify-content: space-between; align-items: center; 
            padding: 0 60px; border-bottom: 8px solid var(--main-blue); 
        }
        .logo img { height: 80px; width: auto; object-fit: contain; }
        .clock-box { text-align: right; }
        #time { font-size: 85px; font-weight: 900; color: var(--main-blue); line-height: 1; }
        #date { font-size: 36px; color: #666; margin-bottom: 5px; }

        /* 內容區 */
        .viewport { position: relative; height: 1740px; }
        .section { position: absolute; width: 100%; height: 100%; transition: opacity 1.5s ease-in-out; opacity: 0; }
        .section.active { opacity: 1; }

        /* 表格設計：移除活動欄位後加寬其餘欄位 */
        .title { padding: 60px; font-size: 68px; font-weight: bold; color: var(--main-blue); }
        table { width: 960px; margin: 0 auto; border-collapse: collapse; font-size: 46px; table-layout: fixed; }
        th { border-bottom: 4px solid var(--main-blue); padding: 40px 10px; text-align: left; color: #000; }
        td { padding: 50px 10px; border-bottom: 1px solid #eee; word-wrap: break-word; }
        
        .location-tag { color: #0066cc; font-weight: bold; background: #e7f2ff; padding: 10px 20px; border-radius: 15px; }
        .no-data { text-align: center; padding: 200px; color: #bbb; font-size: 50px; }
        
        #poster-img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<header>
    <div class="logo"><img src="logo.png" onerror="this.src='https://via.placeholder.com/300x80?text=LOGO'"></div>
    <div class="clock-box">
        <div id="date">--/--/--</div>
        <div id="time">00:00</div>
    </div>
</header>

<div class="viewport">
    <div id="schedule-sec" class="section active">
        <div class="title">是日活動表</div>
        <table>
            <thead>
                <tr>
                    <th width="25%">時間</th>
                    <th width="45%">地點</th>
                    <th width="30%">負責人</th>
                </tr>
            </thead>
            <tbody id="data-list">
                <tr><td colspan="3" class="no-data">正在同步資料...</td></tr>
            </tbody>
        </table>
    </div>
    <div id="poster-sec" class="section">
        <img id="poster-img" src="">
    </div>
</div>

<script>
    const scheduleUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4_yLW9apo6a7pN1PdN65cTKbnnb8bLCBUNrXwWIiP28rn_G5r7-vB1hqTZXXhr8LerJrSn4f334eu/pub?gid=0&single=true&output=csv';
    const posterUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4_yLW9apo6a7pN1PdN65cTKbnnb8bLCBUNrXwWIiP28rn_G5r7-vB1hqTZXXhr8LerJrSn4f334eu/pub?gid=6573573&single=true&output=csv';

    let posters = [];
    let pIdx = 0;

    // 自動修正 Google Drive 連結格式
    function fixGDriveUrl(url) {
        if (url.includes('drive.google.com')) {
            const idMatch = url.match(/\/d\/(.+?)\//) || url.match(/id=(.+?)(&|$)/);
            if (idMatch) return `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
        }
        return url;
    }

    function updateTime() {
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('date').innerText = now.toLocaleDateString('zh-TW', options);
        document.getElementById('time').innerText = now.toLocaleTimeString('zh-TW', {hour: '2-digit', minute:'2-digit', hour12: false});
    }
    setInterval(updateTime, 1000);

    async function loadData() {
        try {
            // 抓取海報並自動轉換網址
            const pRes = await fetch(posterUrl + '&t=' + Date.now());
            const pText = await pRes.text();
            posters = pText.split('\n').slice(1)
                        .map(line => fixGDriveUrl(line.trim()))
                        .filter(l => l.length > 10);

            // 抓取活動表格
            const sRes = await fetch(scheduleUrl + '&t=' + Date.now());
            const sText = await sRes.text();
            const rows = sText.split(/\r?\n/).map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
            
            const tbody = document.getElementById('data-list');
            tbody.innerHTML = '';
            
            const today = new Date();
            const todayStr = `${String(today.getDate()).padStart(2,'0')}/${String(today.getMonth()+1).padStart(2,'0')}/${String(today.getFullYear()).slice(-2)}`;

            let found = false;
            rows.slice(1).forEach(row => {
                const date = row[0] ? row[0].replace(/["']/g, "").trim() : "";
                if(date === todayStr) {
                    found = true;
                    // 跳過 row[2] (活動內容)，只顯示時間(1)、地點(3)、負責人(4)
                    tbody.innerHTML += `<tr>
                        <td>${row[1]}</td>
                        <td><span class="location-tag">${row[3]}</span></td>
                        <td>${row[4]}</td>
                    </tr>`;
                }
            });
            if(!found) tbody.innerHTML = `<tr><td colspan="3" class="no-data">今日暫無預約活動<br><small>${todayStr}</small></td></tr>`;
        } catch(e) { console.error("Sync Error:", e); }
    }

    function switchMode() {
        const sSec = document.getElementById('schedule-sec');
        const pSec = document.getElementById('poster-sec');
        
        if (sSec.classList.contains('active') && posters.length > 0) {
            sSec.classList.remove('active');
            pSec.classList.add('active');
            document.getElementById('poster-img').src = posters[pIdx];
            pIdx = (pIdx + 1) % posters.length;
            setTimeout(switchMode, 15000); // 海報顯示 15 秒
        } else {
            pSec.classList.remove('active');
            sSec.classList.add('active');
            setTimeout(switchMode, 30000); // 表格顯示 30 秒
        }
    }

    loadData();
    setInterval(loadData, 600000);
    updateTime();
    switchMode();
</script>
</body>
</html>
