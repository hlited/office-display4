<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilingual Signage - Auto Scroll Edition</title>
    <style>
        :root { --main-blue: #003366; --line-color: #d1e7ff; }
        body, html { margin: 0; padding: 0; width: 1080px; height: 1920px; font-family: "Microsoft JhengHei", "Arial", sans-serif; overflow: hidden; background: #fff; }
        
        header { 
            height: 180px; display: flex; justify-content: space-between; align-items: center; 
            padding: 0 60px; border-bottom: 8px solid var(--main-blue); background: white;
            position: relative; z-index: 100;
        }
        .logo img { height: 80px; width: auto; }
        .clock-box { text-align: right; }
        #time { font-size: 85px; font-weight: 900; color: var(--main-blue); line-height: 1; }
        #date { font-size: 32px; color: #666; font-weight: bold; }

        .viewport { position: relative; height: 1740px; }
        .section { position: absolute; width: 100%; height: 100%; transition: opacity 1.5s; opacity: 0; }
        .section.active { opacity: 1; }

        .title { padding: 40px 60px 20px; color: var(--main-blue); }
        .title .zh { font-size: 68px; font-weight: bold; display: block; }
        .title .en { font-size: 36px; color: #555; }

        /* 表格容器：用於控制捲動 */
        .table-container {
            width: 1000px; margin: 0 auto;
            height: 1350px; /* 固定高度，超出則捲動 */
            overflow: hidden; 
            position: relative;
        }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { 
            border-bottom: 4px solid var(--main-blue); padding: 20px 10px; text-align: left; 
            background: white; position: sticky; top: 0; z-index: 10;
        }
        th span { display: block; }
        .th-zh { font-size: 42px; color: #000; }
        .th-en { font-size: 24px; color: #666; font-weight: normal; }
        
        /* 支援換行的關鍵：white-space: pre-line */
        td { 
            padding: 40px 10px; border-bottom: 1px solid #eee; 
            font-size: 40px; word-wrap: break-word; color: #333;
            white-space: pre-line; vertical-align: top;
            line-height: 1.4;
        }
        
        .location-tag { color: #0066cc; font-weight: bold; background: #e7f2ff; padding: 10px 20px; border-radius: 12px; display: inline-block; }
        
        /* 捲動動畫 */
        @keyframes scrollTable {
            0% { transform: translateY(0); }
            100% { transform: translateY(var(--scroll-dist)); }
        }

        .scrolling-body {
            animation: scrollTable var(--scroll-speed) linear infinite;
        }

        #poster-img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<header>
    <div class="logo"><img src="logo.png" onerror="this.src='https://via.placeholder.com/300x80?text=LOGO'"></div>
    <div class="clock-box">
        <div id="date">--/--/--</div>
        <div id="time">00:00</div>
    </div>
</header>

<div class="viewport">
    <div id="schedule-sec" class="section active">
        <div class="title">
            <span class="zh">是日活動表</span><span class="en">Daily Schedule</span>
        </div>
        <div class="table-container">
            <table id="main-table">
                <thead>
                    <tr>
                        <th width="25%"><span class="th-zh">時間</span><span class="th-en">Time</span></th>
                        <th width="45%"><span class="th-zh">場地</span><span class="th-en">Venue</span></th>
                        <th width="30%"><span class="th-zh">租用人士</span><span class="th-en">User</span></th>
                    </tr>
                </thead>
                <tbody id="data-list"></tbody>
            </table>
        </div>
    </div>
    <div id="poster-sec" class="section">
        <img id="poster-img" src="">
    </div>
</div>

<script>
    const scheduleUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcXft1rOplV2fP2kvm81qdI3gJ4iLaRjX-SsnIwsxRALBwfDvfQtjk8_HWJEdDe0G83oTZHeiLcdwp/pub?gid=0&single=true&output=csv';
    const posterUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcXft1rOplV2fP2kvm81qdI3gJ4iLaRjX-SsnIwsxRALBwfDvfQtjk8_HWJEdDe0G83oTZHeiLcdwp/pub?gid=6573573&single=true&output=csv';

    // 強大的 CSV 解析器：處理引號內的換行
    function parseCSV(text) {
        const p = /"([^"]*(?:""[^"]*)*)"|([^,\r\n]+)|(?<=,|^)(?=\r?\n|$|,)|\r?\n/g;
        const rows = [[]];
        let m;
        while (m = p.exec(text)) {
            if (m[0] === '\n' || m[0] === '\r\n') {
                rows.push([]);
            } else {
                let v = m[1] !== undefined ? m[1].replace(/""/g, '"') : m[2] || "";
                rows[rows.length - 1].push(v.trim());
            }
        }
        return rows.filter(r => r.length > 0);
    }

    function updateTime() {
        const now = new Date();
        document.getElementById('date').innerHTML = now.toLocaleDateString('zh-TW', {year:'numeric', month:'long', day:'numeric', weekday:'long'}) + "<br>" + now.toLocaleDateString('en-US', {month:'short', day:'numeric', weekday:'short'});
        document.getElementById('time').innerText = now.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12: false});
    }

    async function loadData() {
        try {
            const pRes = await fetch(posterUrl + '&t=' + Date.now());
            const pText = await pRes.text();
            window.posters = pText.split('\n').slice(1).map(l => l.trim()).filter(l => l.length > 10);

            const sRes = await fetch(scheduleUrl + '&t=' + Date.now());
            const sText = await sRes.text();
            const rows = parseCSV(sText);
            
            const tbody = document.getElementById('data-list');
            tbody.classList.remove('scrolling-body'); // 重置捲動
            tbody.innerHTML = '';
            
            const todayStr = new Date().toLocaleDateString('en-GB').split('/').map((v,i)=>i===2?v.slice(-2):v.padStart(2,'0')).join('/');

            let foundCount = 0;
            rows.slice(1).forEach(row => {
                if(row[0] === todayStr) {
                    foundCount++;
                    tbody.innerHTML += `<tr>
                        <td>${row[1]}</td>
                        <td><span class="location-tag">${row[3]}</span></td>
                        <td>${row[4]}</td>
                    </tr>`;
                }
            });

            // 判斷是否需要自動捲動
            setTimeout(() => {
                const containerHeight = 1350;
                const tableHeight = tbody.offsetHeight;
                if (tableHeight > containerHeight) {
                    const scrollDist = containerHeight - tableHeight - 100;
                    tbody.style.setProperty('--scroll-dist', `${scrollDist}px`);
                    tbody.style.setProperty('--scroll-speed', `${foundCount * 3}s`); // 根據數量調整速度
                    tbody.classList.add('scrolling-body');
                }
            }, 500);

        } catch(e) { console.error(e); }
    }

    let pIdx = 0;
    function switchMode() {
        const sSec = document.getElementById('schedule-sec'), pSec = document.getElementById('poster-sec');
        if (sSec.classList.contains('active') && window.posters?.length > 0) {
            sSec.classList.remove('active'); pSec.classList.add('active');
            document.getElementById('poster-img').src = window.posters[pIdx];
            pIdx = (pIdx + 1) % window.posters.length;
            setTimeout(switchMode, 15000);
        } else {
            pSec.classList.remove('active'); sSec.classList.add('active');
            setTimeout(switchMode, 40000); // 增加表格顯示時間讓它捲動完
        }
    }

    setInterval(updateTime, 1000);
    setInterval(loadData, 600000);
    loadData(); updateTime(); switchMode();
</script>
</body>
</html>
